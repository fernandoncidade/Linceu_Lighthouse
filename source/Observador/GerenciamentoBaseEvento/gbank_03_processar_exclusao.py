import sqlite3
from datetime import datetime
from utils.LogManager import LogManager
logger = LogManager.get_logger()

def processar_exclusao(self, evento):
    try:
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()

            query = """
                SELECT 
                    m.tipo_operacao,
                    m.nome,
                    m.dir_anterior,
                    m.dir_atual,
                    m.data_criacao,
                    m.data_modificacao,
                    m.data_acesso,
                    m.tipo,
                    m.size_b,
                    m.size_kb,
                    m.size_mb,
                    m.size_gb,
                    m.size_tb,
                    m.atributos,
                    m.autor,
                    m.dimensoes,
                    m.duracao, 
                    m.taxa_bits,
                    m.protegido,
                    m.paginas,
                    m.linhas,
                    m.palavras,
                    m.paginas_estimadas,
                    m.linhas_codigo,
                    m.total_linhas,
                    m.slides_estimados,
                    m.arquivos,
                    m.unzipped_b,
                    m.unzipped_kb,
                    m.unzipped_mb,
                    m.unzipped_gb,
                    m.unzipped_tb,
                    m.slides,
                    m.binary_file_b,
                    m.binary_file_kb,
                    m.binary_file_mb,
                    m.binary_file_gb,
                    m.binary_file_tb,
                    m.planilhas,
                    m.colunas,
                    m.registros,
                    m.tabelas,
                    m.timestamp
                FROM monitoramento m
                WHERE m.nome = ?

                UNION ALL

                SELECT 
                    NULL as tipo_operacao,
                    s.nome,
                    s.diretorio as dir_anterior,
                    s.diretorio as dir_atual,
                    s.data_criacao,
                    s.data_modificacao,
                    s.data_acesso,
                    s.tipo,
                    s.size_b,
                    s.size_kb,
                    s.size_mb,
                    s.size_gb,
                    s.size_tb,
                    s.atributos,
                    s.autor,
                    s.dimensoes,
                    s.duracao, 
                    s.taxa_bits,
                    s.protegido,
                    s.paginas,
                    s.linhas,
                    s.palavras,
                    s.paginas_estimadas,
                    s.linhas_codigo,
                    s.total_linhas,
                    s.slides_estimados,
                    s.arquivos,
                    s.unzipped_b,
                    s.unzipped_kb,
                    s.unzipped_mb,
                    s.unzipped_gb,
                    s.unzipped_tb,
                    s.slides,
                    s.binary_file_b,
                    s.binary_file_kb,
                    s.binary_file_mb,
                    s.binary_file_gb,
                    s.binary_file_tb,
                    s.planilhas,
                    s.colunas,
                    s.registros,
                    s.tabelas,
                    s.timestamp
                FROM snapshot s
                WHERE s.nome = ?
                ORDER BY timestamp DESC
                LIMIT 1
            """

            cursor.execute(query, (evento.get("nome"), evento.get("nome")))
            result = cursor.fetchone()

            colunas = [
                "tipo_operacao",
                "nome",
                "dir_anterior",
                "dir_atual",
                "data_criacao",
                "data_modificacao",
                "data_acesso",
                "tipo",
                "size_b",
                "size_kb",
                "size_mb",
                "size_gb",
                "size_tb",
                "atributos",
                "autor",
                "dimensoes",
                "duracao", 
                "taxa_bits",
                "protegido",
                "paginas",
                "linhas",
                "palavras",
                "paginas_estimadas",
                "linhas_codigo",
                "total_linhas",
                "slides_estimados",
                "arquivos",
                "unzipped_b",
                "unzipped_kb",
                "unzipped_mb",
                "unzipped_gb",
                "unzipped_tb",
                "slides",
                "binary_file_b",
                "binary_file_kb",
                "binary_file_mb",
                "binary_file_gb",
                "binary_file_tb",
                "planilhas",
                "colunas",
                "registros",
                "tabelas",
                "timestamp"
            ]

            if result:
                metadados = dict(zip(colunas, result))

            else:
                metadados = {
                    "nome": evento.get("nome"),
                    "dir_anterior": evento.get("dir_anterior"),
                    "dir_atual": "",
                    "tipo": self.observador.gerenciador_colunas.identificar_tipo_arquivo(evento.get("nome")),
                    "data_criacao": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    "data_modificacao": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    "data_acesso": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    "size_b": "",
                    "size_kb": "",
                    "size_mb": "",
                    "size_gb": "",
                    "size_tb": "",
                    "atributos": "",
                    "autor": "",
                    "dimensoes": "",
                    "duracao": "",
                    "taxa_bits": "",
                    "protegido": "",
                    "paginas": "",
                    "linhas": "",
                    "palavras": "",
                    "paginas_estimadas": "",
                    "linhas_codigo": "",
                    "total_linhas": "",
                    "slides_estimados": "",
                    "arquivos": "",
                    "unzipped_b": "",
                    "unzipped_kb": "",
                    "unzipped_mb": "",
                    "unzipped_gb": "",
                    "unzipped_tb": "",
                    "slides": "",
                    "binary_file_b": "",
                    "binary_file_kb": "",
                    "binary_file_mb": "",
                    "binary_file_gb": "",
                    "binary_file_tb": "",
                    "planilhas": "",
                    "colunas": "",
                    "registros": "",
                    "tabelas": ""
                }

            valores = (
                self.observador.loc.get_text("op_deleted"),
                metadados.get("nome"),
                evento.get("dir_anterior"),
                "",
                metadados.get("data_criacao"),
                metadados.get("data_modificacao"),
                metadados.get("data_acesso"),
                metadados.get("tipo"),
                metadados.get("size_b"),
                metadados.get("size_kb"),
                metadados.get("size_mb"),
                metadados.get("size_gb"),
                metadados.get("size_tb"),
                metadados.get("atributos"),
                metadados.get("autor"),
                metadados.get("dimensoes"),
                metadados.get("duracao"),
                metadados.get("taxa_bits"),
                metadados.get("protegido"),
                metadados.get("paginas", ""),
                metadados.get("linhas", ""),
                metadados.get("palavras", ""),
                metadados.get("paginas_estimadas", ""),
                metadados.get("linhas_codigo", ""),
                metadados.get("total_linhas", ""),
                metadados.get("slides_estimados", ""),
                metadados.get("arquivos", ""),
                metadados.get("unzipped_b", ""),
                metadados.get("unzipped_kb", ""),
                metadados.get("unzipped_mb", ""),
                metadados.get("unzipped_gb", ""),
                metadados.get("unzipped_tb", ""),
                metadados.get("slides", ""),
                metadados.get("binary_file_b", ""),
                metadados.get("binary_file_kb", ""),
                metadados.get("binary_file_mb", ""),
                metadados.get("binary_file_gb", ""),
                metadados.get("binary_file_tb", ""),
                metadados.get("planilhas", ""),
                metadados.get("colunas", ""),
                metadados.get("registros", ""),
                metadados.get("tabelas", ""),
                datetime.now().strftime("%Y-%m-%d %H:%M:%S.%f")
            )
            cursor.execute("BEGIN TRANSACTION")

            cursor.execute("""
                INSERT INTO excluido (
                            tipo_operacao,
                            nome,
                            dir_anterior,
                            dir_atual,
                            data_criacao,
                            data_modificacao,
                            data_acesso,
                            tipo,
                            size_b,
                            size_kb,
                            size_mb,
                            size_gb,
                            size_tb,
                            atributos,
                            autor,
                            dimensoes,
                            duracao,
                            taxa_bits,
                            protegido,
                            paginas,
                            linhas,
                            palavras,
                            paginas_estimadas,
                            linhas_codigo,
                            total_linhas,
                            slides_estimados,
                            arquivos,
                            unzipped_b,
                            unzipped_kb,
                            unzipped_mb,
                            unzipped_gb,
                            unzipped_tb,
                            slides,
                            binary_file_b,
                            binary_file_kb,
                            binary_file_mb,
                            binary_file_gb,
                            binary_file_tb,
                            planilhas,
                            colunas,
                            registros,
                            tabelas,
                            timestamp
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, valores)

            cursor.execute("""
                INSERT INTO monitoramento (
                            tipo_operacao,
                            nome,
                            dir_anterior,
                            dir_atual,
                            data_criacao,
                            data_modificacao,
                            data_acesso,
                            tipo,
                            size_b,
                            size_kb,
                            size_mb,
                            size_gb,
                            size_tb,
                            atributos,
                            autor,
                            dimensoes,
                            duracao,
                            taxa_bits,
                            protegido,
                            paginas,
                            linhas,
                            palavras,
                            paginas_estimadas,
                            linhas_codigo,
                            total_linhas,
                            slides_estimados,
                            arquivos,
                            unzipped_b,
                            unzipped_kb,
                            unzipped_mb,
                            unzipped_gb,
                            unzipped_tb,
                            slides,
                            binary_file_b,
                            binary_file_kb,
                            binary_file_mb,
                            binary_file_gb,
                            binary_file_tb,
                            planilhas,
                            colunas,
                            registros,
                            tabelas,
                            timestamp
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, valores)

            cursor.execute("COMMIT")

            if not evento.get("_temporario", False):
                self._atualizar_interface_apos_exclusao()

    except Exception as e:
        logger.error(f"Erro ao processar exclusão: {e}", exc_info=True)
        try:
            if 'conn' in locals():
                cursor.execute("ROLLBACK")

        except Exception as ex:
            logger.error(f"Erro ao executar ROLLBACK: {ex}", exc_info=True)
